# ====================================================================================
# Woodlin 开发环境 - Docker Compose 配置
#
# 快速启动开发环境，包含：
# - MySQL 8.0 数据库（自动初始化）
# - Redis 7.x 缓存
# - Woodlin 后端应用
# - Nginx 前端服务（可选）
#
# 使用方法:
# 1. 复制 .env.example 为 .env: cp .env.example .env
# 2. 修改 .env 中的配置（可选）
# 3. 启动服务: docker compose up -d
# 4. 查看日志: docker compose logs -f
# 5. 停止服务: docker compose down
#
# 快速启动脚本: ./scripts/quick-start.sh
# ====================================================================================

version: '3.8'

services:
  # ====================================================================================
  # MySQL 8.0 数据库服务
  # ====================================================================================
  mysql:
    image: mysql:8.0
    container_name: woodlin-mysql
    hostname: mysql
    restart: unless-stopped
    ports:
      - "${DATABASE_PORT:-3306}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${DATABASE_PASSWORD:-123456}
      MYSQL_DATABASE: ${DATABASE_NAME:-woodlin}
      MYSQL_USER: ${DATABASE_USERNAME:-woodlin}
      MYSQL_PASSWORD: ${DATABASE_PASSWORD:-123456}
      TZ: Asia/Shanghai
    volumes:
      - mysql_data:/var/lib/mysql
      # 自动初始化脚本 - 仅在首次启动时执行
      - ./sql/mysql/woodlin_complete_schema.sql:/docker-entrypoint-initdb.d/001-schema.sql:ro
      - ./sql/mysql/woodlin_complete_data.sql:/docker-entrypoint-initdb.d/002-data.sql:ro
    networks:
      - woodlin-network
    healthcheck:
      # Note: Password in health check is from environment variable, which is standard practice in Docker
      # The command runs inside the container and is not exposed in process lists on the host
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DATABASE_PASSWORD:-123456}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-time-zone=+08:00
      - --max-connections=1000

  # ====================================================================================
  # Redis 7.x 缓存服务
  # ====================================================================================
  redis:
    image: redis:7-alpine
    container_name: woodlin-redis
    hostname: redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    environment:
      TZ: Asia/Shanghai
    command:
      - redis-server
      - --requirepass
      - ${REDIS_PASSWORD:-123456}
      - --maxmemory
      - 512mb
      - --maxmemory-policy
      - allkeys-lru
      - --appendonly
      - "yes"
    volumes:
      - redis_data:/data
    networks:
      - woodlin-network
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-123456}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

  # ====================================================================================
  # Woodlin 后端应用服务
  # ====================================================================================
  woodlin-app:
    build:
      context: .
      dockerfile: docker/app/Dockerfile
    container_name: woodlin-app
    hostname: woodlin-app
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${SERVER_PORT:-8080}:8080"
    environment:
      # 数据库配置
      DATABASE_URL: jdbc:mysql://mysql:3306/${DATABASE_NAME:-woodlin}?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
      DATABASE_USERNAME: ${DATABASE_USERNAME:-woodlin}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-123456}
      DATABASE_DRIVER: com.mysql.cj.jdbc.Driver
      
      # Redis 配置
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-123456}
      REDIS_DATABASE: 0
      REDIS_TIMEOUT: 10s
      
      # 服务器配置
      SERVER_PORT: 8080
      SERVER_CONTEXT_PATH: /api
      
      # Spring 配置
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      
      # CORS配置（开发环境允许所有源）
      CORS_ENABLED: true
      CORS_ALLOWED_ORIGIN_PATTERN: http://localhost:*
      
      # 时区
      TZ: Asia/Shanghai
    volumes:
      - app_logs:/app/logs
    networks:
      - woodlin-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # ====================================================================================
  # Nginx 前端服务（可选，使用 --profile frontend 启用）
  # 
  # 启用方法: docker compose --profile frontend up -d
  # ====================================================================================
  nginx:
    image: nginx:alpine
    container_name: woodlin-nginx
    hostname: nginx
    restart: unless-stopped
    profiles:
      - frontend
    depends_on:
      - woodlin-app
    ports:
      - "${NGINX_PORT:-3000}:80"
    environment:
      TZ: Asia/Shanghai
    volumes:
      - ./woodlin-web/dist:/usr/share/nginx/html:ro
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - woodlin-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

# ====================================================================================
# 数据卷定义
# ====================================================================================
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  app_logs:
    driver: local

# ====================================================================================
# 网络定义
# ====================================================================================
networks:
  woodlin-network:
    driver: bridge
    name: woodlin-network
